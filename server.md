# Configuracion Servidor
### Preparativos
#### Configurar tarjeta de red
Configurar la interfaz de la tarjeta de red para que tenga su ip estatica y su DNS
* En nuestro caso la tarjeta de red se llama ens33. Puede tener otros nombres como enp#s# o wlan#
* Modificar el archivo /etc/network/interfaces y añadir la configuracion
```
auto ens33
allow-hotplug ens33
iface ens33 inet static
        address 192.168.100.119
        netmask 255.255.255.0
        network 192.168.100.0
        broadcast 102.168.100.255
        gateway 192.168.100.1
        dns-nameservers 192.168.100.119 8.8.8.8
        dns-search srv.nis
```
#### Asignar dominio 
Añadir siguiente linea a /etc/hosts
```bash
192.168.100.119 Node03.srv.nis srv.nis Node03 srv
```
Esto redirecciona todas las peticiones del dominio del servidor a su ip. El gestor de DNS configura de forma automatica el registro en /etc/resolv.conf 
* Quedaria asi el archivo de configuracion de forma automatica
```
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 192.168.100.119
nameserver 8.8.8.8
search srv.nis
```
## NIS
* Nis funciona para poder centralizar la autenticacion de los clientes linux
1. Instalar NIS
```bash
$ apt -y install nis
```
* Al finalizar aparecera una pantalla de configuracion donde se añadira el dominio del servidor
```
NIS domain:

srv.nis______

    <ok>
``` 
2. Configurar como servidor maestro NIS
* Modificar el archivo /etc/default/nis
```
# Linea 6: Poner a NIS como servidor maestro
NISSERVER=master
```
* Adicionalmente en el mismo archivo de configuracion, se puede configurar un rango de IPs que pueden hacer peticiones a este servicio
```
# Si se deja asi se le dara acceso a todo el mundo
0.0.0.0 0.0.0.0
# Si se configura asi se le dara acceso solo al rango deseado
192.168.100.0 192.168.100.255
```
* Reiniciar el servicio nis en systemd para ver los cambios
```
$ systemctl restart nis
```
3. Aplicar la configuracion al servicio
* Ejecutar el siguiente comando
```
$ /usr/lib/yp/ypinit -m
```
* Si todo sale bien se mostrar un mensaje al final como este
```
Node03.srv.nis has been set up as a NIS master server.

Now you can run ypinit -s Node03.srv.nis on all slave server.
```
4. Cada que tengas que añadir un usuario nuevo se tiene que actualizar la base de datos de NIS. (este ya esta incluido en el script add_user.sh)
* Se ejecuta el siguiente comando dentro del directorio /var/yp
```bash
/var/yp $ make
```
## NFS
* NFS crea un sistema de archivos centralizados por red
1. Instalar el servidor nfs
```
$ apt -y install nfs-kernel-server 
```
2. Configurar el dominio del servidor en el archivo /etc/idmapd.conf
```
# Linea 6: Aqui se descomenta y se agrega el dominio
Domain = srv.nis
```
3. Añadir la ruta de los directorios home que se van a compartir por NFS, esto es en el archivo /etc/exports
```
/home 192.168.100.0/24(rw,no_root_squash,no_subtree_check)
```
* /home es la ruta que se va montar en los clientes
* xx.xx.xx.xx/xx Es la mascara del segmento que puede acceder a estes directorios por NFS
* (*.*.*) Son las opciones de exports
4. Reiniciar el servicio para ver reflekjados los cambios
```
$ systemctl restart nfs-server
```
## SAMBA AD DC
* SAMBA es una implementacion del protocolo smb, a partir de su version 4 añade capacidades para crear y gestionar un controlador de directorio activo (active directory) y kerberos, el cual es compatible con la autenticacion de red por de windows. Active directory es una implementacion del protocolo ldap y kerberos es un protocolo de autenticacion.
1. Instalar el protocolo para la sincronizacion de la hora. Es un requerimiento de kerberos para los miembros del dominio
```
$ apt install ntp
```
2. Instalar los paquetes necesarios para el servidor de Samba 4 con AD DC
```
$ apt install samba smbclient attr winbind libpam-winbind libnss-winbind libpam-krb5 krb5-config krb5-user
```
* Mostrara una ventana de configuracion que pedira algunos parametros
* El primero es el del REALM o reino
```
Reino predeterminado de la versión 5 de Kerberos:
SRV.NIS_________
    <Aceptar>
```
* El siguiente es el nombre del host, el cual se usara el mismo que el reino pero en minúsculas
```
Servidores de Kerberos para su reino:
srv.nis______
    <Aceptar>
```
* La ultima ventana pedira el nombre del host administrativo. Se pone el mismo que el del servidor
```
Servidor administrativo para su reino de Kerberos:
srv.nis_______
    <Aceptar>
```
3. Creacion del controlador de dominio 
* Se paran los servicios antes de configurar esta parte
```
$ systemctl stop samba-ad-dc smbd nmbd winbind
$ systemctl disable samba-ad-dc smbd nmbd winbind
```
* Se elimina o se respalda el archivo de configuracion de samba por defecto
```
mv /etc/samba/smb.conf /etc/samba/smb.conf.org
```
* Se unicia la creacion del controlador de forma interactiva, dotandole de compatibilidad con extensiones NIS rfc2307.
```
$ samba-tool domain provision --use-rfc2307 --interactive
``` 
* En la parte de Realm introducir el usado en este manual. 
```
Realm: srv.nis
```
* En domain dejar el que esta por defecto, solo pulsar enter
```
Domain [SRV]:
```
* En Server Role dejar el que esta por defecto [dc]
```
Server Role (dc, member, standalon) [dc]:
```
* DNS backend, dejar el questa por defecto que es SAMBA_INTERNAL
```
DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]:
```
* DNS fowarder IP address. Dejar la IP del servidor que en este caso es 192.168.100.119
```
DNS forwarder IP address (write 'none' to disable forwarding) [127.0.0.1]: 192.168.100.119
```
* Administrator password: Esta es la contraseña de administrador, poner una que sea mayor a 8 caracteres con una mayuscula y un digito
```
Administrator password:
Retype password:
```
* Si todo sale bien mostrara los datos con controlador de dominio
```
Server Role:           active directory domain controller
Hostname:              Node03
NetBIOS Domain:        SRV
DNS Domain:            srv.nis
DOMAIN SID:            S-1-5-21-3772837808-1505251784-1375148484
```
* Iniciar la familia de los demonios del samba-ad-dc
```
$ systemctl unmask samba-ad-dc
$ systemctl start samba-ad-dc
$ systemctl enable samba-ad-dc
```
4. Probar la configuracion 
* Verificar el nivel de dominio
```
$ samba-tool domain level show
```
* Si todo sale bien debe mostrar lo siguiente
```
Domain and forest function level for domain 'DC=srv,DC=nis'

Forest function level: (Windows) 2008 R2
Domain function level: (Windows) 2008 R2
Lowest function level of a DC: (Windows) 2008 R2
```
* Verificar el servidor de archivos. netlogon y sysvol
```
$ smbclient -L localhost -U%
```
* Debe mostrar lo siguiente:
```
       Sharename       Type      Comment
        ---------       ----      -------
        homes           Disk      Home Directories
        netlogon        Disk
        sysvol          Disk
        IPC$            IPC       IPC Service (Samba 4.9.5-Debian)
Reconnecting with SMB1 for workgroup listing.

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        WORKGROUP            NODE03
        WORKSOMCH            VENGANZASS
```
* En el caso anterior mostro los directorios configurados y los workgroups existentes de otras maquinas windows en la red
* Verificar la autenticacion usando el usuario de administrador del dominio
```
smbclient //localhost/netlogon -UAdministrator -c 'ls'
```
* Si todo sale bien debe mostrar esto
```
Enter SRV\Administrator's password:
  .                                   D        0  Sun May 10 20:07:09 2020
  ..                                  D        0  Sun May 10 20:07:12 2020

                19478160 blocks of size 1024. 17106040 blocks available
```
5. Verificar los registros de DNS. Importante que si los muestre ya que sin estos windows no sera capaz de detectar el dominio
* SRV de ldap usando TCP
```
$ host -t SRV _ldap._tcp.srv.nis
```
* SRV de kerberos usando UDP
```
$ host -t SRV _kerberos._udp.srv.nis
```
* A del dominio
```
host -t A Node03.srv.nis
```
6. Si todo salio bien entonces el servidor ya esta correctamente configurado
* A veces hay que abrir los puertos en el firewall en caso de tener problemas
